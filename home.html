<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary-teal: #008080;
            --dark-teal: #07323E;
            --light-teal: #E6F4F1;
            --text-main: #1a1a1a;
            --bg-body: #f8fafc;
            --sidebar-width: 320px;
            --header-height: 120px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            width: 100%;
            height: var(--header-height);
            background: #07323E;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ffffff;
            transition: background 0.3s ease;
        }

        .page-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 40px 30px;
            z-index: 100;
        }

        .nav-items-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .nav-spacer {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 18px 24px;
            border-radius: 16px;
            text-decoration: none;
            color: black;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            font-weight: 550;
            font-size: 19px;
        }

        .nav-item i {
            margin-right: 16px;
            font-size: 24px;
        }

        .nav-item.active {
            background-color: #D0E6E3;
            color: #093E4E;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .dashboard-container {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
            max-width: 1400px;
        }

        .card {
            border-radius: 24px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
            grid-column: span 4;
            transition: opacity 0.5s ease;
        }

        .dark-card {
            background: #2C2B2B;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            text-align: left;
        }

        .dark-card .icon-box i {
            font-size: 40px;
            color: #E6DDD0;
            margin-bottom: 20px;
            margin-left: 20px;
            margin-top: 15px;
        }

        .dark-card h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 32px;
            width: 70%;
            margin: 0;
            margin-left: 20px;
            line-height: 1.1;
            color: #ffffff;
            font-weight: 600;
        }

        .dark-card .subtitle {
            font-family: 'Poppins', sans-serif;
            font-size: 32px;
            color: #E6DDD0;
            font-weight: 600;
            margin-left: 20px;
            line-height: 1.1;
        }

        .light-card {
            background-color: #D0E6E3;
            border: none;
        }

        .light-card h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 32px;
            line-height: 1.1;
            color: #07323E;
            font-weight: 600;
            margin-left: 20px;
        }

        .light-card .icon-box i {
            font-size: 40px;
            color: #07323E;
            margin-bottom: 20px;
            margin-left: 20px;
            margin-top: 15px;
        }

        .score-circle {
            width: fit-content;
            min-width: 60px;
            height: 60px;
            border: 5px solid var(--primary-teal);
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 20px;
            margin-bottom: 15px;
            padding: 0 15px;
            color: var(--primary-teal);
            font-weight: 600;
            font-size: 24px;
        }

        .pattern {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 100%;
            background: url("IMG/patt.png");
            background-size: 160px 132px;
            opacity: 0.06;
            pointer-events: none;
        }

        .action-btn {
            background: var(--dark-teal);
            color: #D0E6E3;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 18px;
            cursor: pointer;
            width: fit-content;
            margin-left: 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #99a8aa;
            color: #07323E;
        }

        /* State management class */
        .dimmed {
            opacity: 0.5;
            pointer-events: none;
        }

        @media (max-width: 1200px) {
            .dashboard-container { grid-template-columns: 1fr; }
            .card { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <!-- SVG Logo same as before -->
            <svg class ="logo-svg" width="227" height="62" viewBox="0 0 227 62" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M79.5604 19.2723C81.9415 19.2723 84.0632 19.7913 85.9254 20.8292C87.8182 21.8672 89.2988 23.3325 90.3673 25.2253C91.4357 27.118 91.97 29.3008 91.97 31.7735C91.97 34.2463 91.4357 36.4443 90.3673 38.3676C89.2988 40.2603 87.8182 41.7257 85.9254 42.7636C84.0632 43.8016 81.9415 44.3205 79.5604 44.3205C76.2633 44.3205 73.6532 43.2215 71.7299 41.0235V52.8836H66.0059V19.5471H71.4552V22.7525C72.4015 21.5924 73.5616 20.7224 74.9354 20.1424C76.3396 19.5623 77.8813 19.2723 79.5604 19.2723ZM78.9193 39.4208C81.0257 39.4208 82.7505 38.7187 84.0938 37.3144C85.4675 35.9101 86.1544 34.0631 86.1544 31.7735C86.1544 29.4839 85.4675 27.637 84.0938 26.2327C82.7505 24.8284 81.0257 24.1263 78.9193 24.1263C77.5455 24.1263 76.3091 24.4468 75.2101 25.0879C74.1111 25.6985 73.2411 26.5838 72.6 27.7438C71.9589 28.9039 71.6383 30.2471 71.6383 31.7735C71.6383 33.2999 71.9589 34.6432 72.6 35.8032C73.2411 36.9633 74.1111 37.8639 75.2101 38.505C76.3091 39.1155 77.5455 39.4208 78.9193 39.4208ZM122.218 39.604C122.981 39.604 123.698 39.4666 124.37 39.1918L123.775 43.7252C122.706 44.1221 121.516 44.3205 120.203 44.3205C118.585 44.3205 117.242 43.9847 116.173 43.3131C115.105 42.611 114.387 41.6493 114.021 40.4282C112.922 41.6799 111.609 42.6415 110.083 43.3131C108.587 43.9847 106.908 44.3205 105.046 44.3205C103.031 44.3205 101.199 43.8932 99.5507 43.0384C97.9327 42.1836 96.6505 40.9472 95.7042 39.3292C94.7578 37.6807 94.2846 35.7574 94.2846 33.5594C94.2846 30.8424 94.8799 28.4002 96.0705 26.2327C97.2916 24.0347 98.9401 22.3251 101.016 21.104C103.122 19.8829 105.473 19.2723 108.068 19.2723C111.976 19.2723 114.754 20.5698 116.402 23.1646L117.089 19.5471H122.813L119.516 35.9864C119.424 36.3527 119.379 36.7038 119.379 37.0396C119.379 37.8639 119.623 38.505 120.111 38.9629C120.6 39.3903 121.302 39.604 122.218 39.604ZM106.511 39.4208C108.129 39.4208 109.564 39.0392 110.816 38.276C112.098 37.4823 113.105 36.3985 113.838 35.0248C114.57 33.6205 114.937 32.033 114.937 30.2624C114.937 28.3391 114.372 26.8433 113.243 25.7748C112.113 24.6758 110.526 24.1263 108.48 24.1263C106.862 24.1263 105.412 24.5231 104.13 25.3169C102.878 26.0801 101.886 27.1638 101.153 28.5681C100.421 29.9419 100.054 31.514 100.054 33.2847C100.054 35.2079 100.619 36.7191 101.749 37.8181C102.878 38.8866 104.466 39.4208 106.511 39.4208ZM135.606 44.2748C131.546 44.2748 129.317 42.0157 128.921 37.4975L126.768 38.7797L125.624 35.3911L129.47 32.7352L131.256 22.0198C131.867 18.5091 132.981 15.8837 134.599 14.1436C136.217 12.4035 138.109 11.5335 140.277 11.5335C142.048 11.5335 143.421 12.083 144.398 13.182C145.406 14.281 145.909 15.8227 145.909 17.807C145.909 19.9745 145.345 22.0504 144.215 24.0347C143.086 26.019 141.758 27.7744 140.231 29.3008C138.735 30.7966 136.98 32.3536 134.965 33.9716C134.874 34.6126 134.828 35.1774 134.828 35.6659C134.828 37.7112 135.698 38.7339 137.438 38.7339C138.445 38.7339 139.392 38.4134 140.277 37.7723C141.162 37.1007 142.063 36.2306 142.979 35.1621L145.406 38.1844C142.811 42.2446 139.544 44.2748 135.606 44.2748ZM135.973 27.927C137.438 26.4617 138.705 24.8437 139.773 23.0731C140.872 21.3024 141.422 19.5929 141.422 17.9444C141.422 17.3033 141.3 16.7996 141.055 16.4332C140.811 16.0364 140.491 15.8379 140.094 15.8379C138.72 15.8379 137.728 17.6543 137.117 21.2872L135.973 27.927ZM179.961 19.2723C183.044 19.2723 185.486 20.1729 187.287 21.974C189.089 23.7447 189.989 26.4159 189.989 29.9876V44H184.265V30.7203C184.265 28.5834 183.792 26.9806 182.846 25.9122C181.899 24.8132 180.541 24.2636 178.77 24.2636C176.847 24.2636 175.305 24.9047 174.145 26.1869C172.985 27.4386 172.405 29.2397 172.405 31.5904V44H166.681V30.7203C166.681 28.5834 166.208 26.9806 165.262 25.9122C164.315 24.8132 162.957 24.2636 161.186 24.2636C159.232 24.2636 157.675 24.8895 156.515 26.1411C155.386 27.3928 154.821 29.2092 154.821 31.5904V44H149.097V19.5471H154.546V22.6609C155.462 21.5619 156.607 20.7224 157.981 20.1424C159.354 19.5623 160.881 19.2723 162.56 19.2723C164.391 19.2723 166.009 19.6234 167.414 20.3255C168.849 20.9972 169.978 22.0046 170.802 23.3478C171.81 22.0656 173.107 21.0735 174.695 20.3713C176.282 19.6387 178.037 19.2723 179.961 19.2723ZM221.207 39.604C221.97 39.604 222.688 39.4666 223.359 39.1918L222.764 43.7252C221.696 44.1221 220.505 44.3205 219.192 44.3205C217.574 44.3205 216.231 43.9847 215.163 43.3131C214.094 42.611 213.377 41.6493 213.01 40.4282C211.911 41.6799 210.599 42.6415 209.072 43.3131C207.576 43.9847 205.897 44.3205 204.035 44.3205C202.02 44.3205 200.189 43.8932 198.54 43.0384C196.922 42.1836 195.64 40.9472 194.694 39.3292C193.747 37.6807 193.274 35.7574 193.274 33.5594C193.274 30.8424 193.869 28.4002 195.06 26.2327C196.281 24.0347 197.93 22.3251 200.005 21.104C202.112 19.8829 204.463 19.2723 207.057 19.2723C210.965 19.2723 213.743 20.5698 215.392 23.1646L216.078 19.5471H221.802L218.505 35.9864C218.414 36.3527 218.368 36.7038 218.368 37.0396C218.368 37.8639 218.612 38.505 219.101 38.9629C219.589 39.3903 220.291 39.604 221.207 39.604ZM205.501 39.4208C207.118 39.4208 208.553 39.0392 209.805 38.276C211.087 37.4823 212.095 36.3985 212.827 35.0248C213.56 33.6205 213.926 32.033 213.926 30.2624C213.926 28.3391 213.361 26.8433 212.232 25.7748C211.102 24.6758 209.515 24.1263 207.47 24.1263C205.852 24.1263 204.402 24.5231 203.119 25.3169C201.868 26.0801 200.876 27.1638 200.143 28.5681C199.41 29.9419 199.044 31.514 199.044 33.2847C199.044 35.2079 199.609 36.7191 200.738 37.8181C201.868 38.8866 203.455 39.4208 205.501 39.4208Z" fill="#D0E6E3"/>
                <circle cx="26.1549" cy="34.3388" r="20.3766" fill="#D0E6E3"/>
                <path d="M10.144 32.9103C11.4689 30.3055 15.1901 30.3055 16.515 32.9103V32.9103V32.9103C18.1084 35.3601 16.2478 38.5827 13.3295 38.4277V38.4277V38.4277C10.4112 38.5827 8.55062 35.3601 10.144 32.9103V32.9103V32.9103Z" fill="#07323E"/>
                <path d="M38.6171 18.5739C41.6345 18.5739 44.3231 19.2315 46.6829 20.5468C49.0814 21.8621 50.9576 23.719 52.3116 26.1175C53.6656 28.516 54.3426 31.2819 54.3426 34.4154C54.3426 37.5489 53.6656 40.3343 52.3116 42.7714C50.9576 45.1699 49.0814 47.0268 46.6829 48.3421C44.3231 49.6574 41.6345 50.315 38.6171 50.315C34.4391 50.315 31.1315 48.9223 28.6943 46.137V61.1662H21.4409V18.9221H28.3462V22.984C29.5454 21.514 31.0154 20.4114 32.7563 19.6764C34.5358 18.9414 36.4894 18.5739 38.6171 18.5739ZM37.8047 44.1061C40.4739 44.1061 42.6597 43.2163 44.3618 41.4368C46.1026 39.6573 46.973 37.3168 46.973 34.4154C46.973 31.5141 46.1026 29.1736 44.3618 27.3941C42.6597 25.6146 40.4739 24.7248 37.8047 24.7248C36.0638 24.7248 34.4971 25.131 33.1044 25.9434C31.7118 26.7171 30.6092 27.839 29.7969 29.309C28.9845 30.779 28.5783 32.4812 28.5783 34.4154C28.5783 36.3497 28.9845 38.0518 29.7969 39.5219C30.6092 40.9919 31.7118 42.1331 33.1044 42.9455C34.4971 43.7192 36.0638 44.1061 37.8047 44.1061Z" fill="#07323E"/>
            </svg>
        </div>
        <button class="profile-btn">
            <i class="material-icons-round">person</i>
        </button>
    </header>

    <div class="page-body">
        <nav class="sidebar">
            <div class="nav-items-wrapper">
                <a href="#" class="nav-item active">
                    <i class="material-icons-round">home</i>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="material-icons-round">self_improvement</i>
                    <span>Reflection</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="material-icons-round">forum</i>
                    <span>Chat with Alma</span>
                </a>
                <div class="nav-spacer"></div>
                <a href="#" class="nav-item">
                    <i class="material-icons-round">settings</i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <div class="main-content">
            <div class="dashboard-container">
                <!-- ROW 1 -->
                <div id="gm" class="card dark-card">
                    <div class="icon-box"><i id="greetingIcon" class="material-icons-round">wb_sunny</i></div>
                    <div class="text-group">
                        <h2 id="greetingText">Good Morning,</h2>
                        <div id="userName" class="subtitle">User</div>
                    </div>
                </div>

                <div class="card light-card">
                    <div class="pattern"></div>
                    <div>
                        <div class="icon-box"><i class="material-icons-round">book</i></div>
                        <h2>Reflection<br>Time</h2>
                    </div>
                    <button id="reflectionBtn" class="action-btn">Loading...</button>
                </div>

                <div id="healthScoreCard" class="card light-card" style="background: #ffffff; border: 1px solid #e2e8f0;">
                    <div class="icon-box"><i style="color:#008080" class="material-icons-round">favorite</i></div>
                    <div id="healthScoreCircle" class="score-circle">85</div>
                    <div class="text-group">
                        <h2 style="color: var(--dark-teal); margin-left: 20px; line-height: 0.98;">Health</h2>
                        <div style="color: var(--primary-teal); margin-left: 20px; line-height: 0.98; font-size: 32px; font-weight: 600;">Score</div>
                    </div>
                </div>

                <!-- ROW 2 -->
                <div id="pastTrendCard" class="card dark-card" style="background: #D0E6E3; border: 1px solid #2C2B2B;">
                    <div class="icon-box"><i class="material-icons-round" style="color:#07323E">arrow_upward</i></div>
                    <div class="text-group">
                        <h2 style="width: 100%; color:black;">View Your</h2>
                        <div class="subtitle" style="color:#093E4E;">Past Trends</div>
                    </div>
                </div>

                <div id="energyCard" class="card dark-card" style="background: #2C2B2B; border: 1px solid #e2e8f0;">
                    <div class="icon-box" style="color: #E6DDD0;"><i class="material-icons-round" style="color: #E6DDD0;">lightbulb</i></div>
                    <div class="text-group">
                        <h2 id="energyText" style="color: white; margin-left: 20px; width: 85%;">You feel more energetic on days you eat earlier.</h2>
                    </div>
                </div>

                <div class="card" style="background: #1D5667; border: none;">
                    <div class="icon-box"><i class="material-icons-round" style="color: #ffffff; font-size: 40px; margin-left: 20px; margin-top: 15px; margin-bottom: 20px;">forum</i></div>
                    <div class="text-group">
                        <h2 style="color: #ffffff; margin-left: 20px; width: 95%; font-weight:550; line-height: 1.1; font-size: 35px;">Chat with Alma. Gain insights. <span style="font-size: 16px; opacity: 0.9; font-weight: 400;"><br>(non-medical use)</span></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const USER_ID = localStorage.getItem("user_id");
        if (!USER_ID) {
            window.location.href = "/login";
        }

        async function checkHealthScore() {
            try {
                const response = await fetch('/check-hs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: USER_ID })
                });

                if (!response.ok) throw new Error('Failed to check health score');
                const data = await response.json();

                if (data.hsExist === false) {
                    // Dim cards
                    document.getElementById('healthScoreCard').classList.add('dimmed');
                    document.getElementById('pastTrendCard').classList.add('dimmed');
                    document.getElementById('energyCard').classList.add('dimmed');
                    
                    // Update content
                    document.getElementById('healthScoreCircle').textContent = "Set Up";
                    document.getElementById('energyText').textContent = "Set up Reflection Time first";
                }
            } catch (error) {
                console.error('Error checking health score:', error);
            }
        }

        async function fetchReflectionData() {
            const btn = document.getElementById('reflectionBtn');
            try {
                const response = await fetch('/reflect-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: USER_ID })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.hasReflectionTime) {
                    updateReflectionButton(data.reflectionTime);
                } else {
                    btn.innerHTML = `Set up`;
                    btn.disabled = false;
                    btn.style.backgroundColor = 'var(--dark-teal)';
                    btn.style.color = '#D0E6E3';
                    btn.onclick = () => window.location.href = '/reflection';
                }
            } catch (error) {
                console.error('Error fetching reflection data:', error);
                btn.innerHTML = `Set up`;
                btn.disabled = false;
            }
        }

        function updateReflectionButton(scheduledTimeStr) {
            const btn = document.getElementById('reflectionBtn');
            const now = new Date();
            const [hours, minutes] = scheduledTimeStr.split(':').map(Number);
            const scheduleDate = new Date();
            scheduleDate.setHours(hours, minutes, 0, 0);

            const isAllowed = now >= scheduleDate;
            
            if (isAllowed) {
                btn.innerHTML = `Start Reflection`;
                btn.disabled = false;
                btn.style.backgroundColor = 'var(--dark-teal)';
                btn.style.color = '#D0E6E3';
                btn.onclick = () => window.location.href = '/reflection';
            } else {
                btn.innerHTML = `<span>‚è∞</span> ${scheduledTimeStr}`;
                btn.disabled = true;
                btn.onclick = null;
                btn.style.backgroundColor = '#99a8aa';
                btn.style.color = '#07323E';
            }
        }

        function initDashboard() {
            const storedName = localStorage.getItem("user_name");
            if (storedName) {
                document.getElementById('userName').textContent = storedName;
            }

            const hour = new Date().getHours();
            const greetingEl = document.getElementById('greetingText');
            const iconEl = document.getElementById('greetingIcon');
            
            let timeText = "Good Morning,";
            let iconText = "wb_sunny";

            if (hour >= 12 && hour < 17) {
                timeText = "Good Afternoon,";
                iconText = "wb_twilight";
            } else if (hour >= 17 && hour < 21) {
                timeText = "Good Evening,";
                iconText = "nights_stay";
            } else if (hour >= 21 || hour < 5) {
                timeText = "Good Night,";
                iconText = "bedtime";
            }

            greetingEl.textContent = timeText;
            iconEl.textContent = iconText;

            // Sequential data fetching
            fetchReflectionData();
            checkHealthScore();
        }
        
        window.onload = initDashboard;
    </script>
</body>
</html>